# Torexxx-Agent (LLM-Agents)

Агент для нормализации промта и генерации кода через OpenRouter. Поддерживает пул моделей, фолбэки, стрим-фолбэк, YAML-шаблоны и автоподбор шаблонов нейросетью.

## Установка

- Требуется Node.js ≥ 18
- Установите зависимости: `npm install`
- Установите ключи провайдеров: `OPENROUTER_API_KEY`

## Быстрый старт

- Сгенерировать проект:
  - `node bin/torexxx-agent.js --prompt "Сделай лендинг психолога с записью на консультацию"`
- Опционально указать шаблоны вручную (не обязательно):
  - `node bin/torexxx-agent.js --prompt "CLI утилита для конвертации CSV" --templates cli_tool`

## Модели и фолбэки

- `OR_MODEL_REFINE`, `OR_MODELS_REFINE`: пул моделей для нормализации
- `OR_MODEL_CODEGEN`, `OR_MODELS_CODEGEN`: пул для кодогенерации
- Фолбэки: по 429/403/ошибкам — последовательный переход к следующей модели
- Стрим-фолбэк: при ошибке стриминга — запрос без стрима

## Переменные окружения

- `OPENROUTER_API_KEY` — основное
- `AGENT_TEMPLATES` — опционально, имена шаблонов через запятую, если хотите принудительно применить
- `OR_*` — управление моделями/фолбэками, см. выше

## Формат FILE-блока

Строгий формат вывода: FILE: <путь> в начале файла, затем содержимое.

## Артефакты сохранения

- `Torexxx-Agent/output` — файлы проекта
- `Torexxx-Agent/raw` — сырой вывод модели
- `Torexxx-Agent/templates/requests.jsonl` — журнал запросов под отсутствующие шаблоны

## Шаблоны (YAML)

Шаблоны находятся в `templates/*.yaml`. Поля шаблона:

- `name` — короткое имя
- `description` — описание/контекст
- `stack` — технологии (превращаются в `constraints` с префиксом `stack:`)
- `structure` — список файлов (превращается в `files`)
- `rules`, `style` — требования/стандарты (превращаются в `constraints`)
- `example_prompt` — пример запроса

### Автовыбор шаблонов нейросетью

- На стадии нормализации запроса агент передаёт модели каталог доступных шаблонов: имена и краткие описания.
- Модель возвращает в JSON поле `templates` — список выбранных имён.
- Если подходящего шаблона нет, модель может заполнить `template_suggestion` — короткое имя для будущего шаблона.
- Агент применяет выбранные шаблоны автоматически. Если указанные имена не найдены, он записывает заявку в `Torexxx-Agent/templates/requests.jsonl`.
- CLI-флаг `--templates` и `AGENT_TEMPLATES` остаются доступными как резервный вариант, но уступают выбору модели.

### Применение шаблонов

- `rules`, `style`, `stack` → добавляются в `constraints` (стек помечается как `stack:<tech>`)
- `structure` → пути файлов добавляются в `files`
- `description` → дополняет `overview`
- Дубликаты убираются автоматически

### Примеры

- Автовыбор: `node bin/torexxx-agent.js --prompt "Сделай лендинг психолога"`
- Ручной выбор (если нужно): `node bin/torexxx-agent.js --prompt "Бэкенд на Express" --templates api_backend`

## Рекомендованные бесплатные модели

См. `free-models.md` (прилагается).